{% extends 'base.html' %}

{% block content %}
<div class="dashboard-container">

    <!-- KPIs Section -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <h3>Total Licencias</h3>
            <span class="kpi-value">{{ kpis.total }}</span>
        </div>
        <div class="kpi-card status-active">
            <h3>Activas</h3>
            <span class="kpi-value">{{ kpis.active }}</span>
        </div>
        <a href="{{ url_for('dashboard', status='expiring_soon') }}" class="kpi-card status-pending"
            style="text-decoration: none; color: inherit; display: block;">
            <h3>Por Vencer (7d)</h3>
            <span class="kpi-value">{{ kpis.expiring_soon }}</span>
        </a>
        <div class="kpi-card status-pending">
            <h3>Pendientes</h3>
            <span class="kpi-value">{{ kpis.pending }}</span>
        </div>
        <div class="kpi-card status-expired">
            <h3>Expiradas</h3>
            <span class="kpi-value">{{ kpis.expired }}</span>
        </div>
        <div class="kpi-card status-blocked">
            <h3>Bloqueadas</h3>
            <span class="kpi-value">{{ kpis.blocked }}</span>
        </div>
    </div>

    <!-- Actions & Filters -->
    <div class="dashboard-actions">
        <!-- ... (existing actions) ... -->
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="openModal('create-modal')">
                + Nueva Licencia
            </button>
            <a href="{{ url_for('export_csv', status=current_filters.status, type=current_filters.type, q=current_filters.q) }}"
                class="btn btn-secondary btn-with-icon" style="text-decoration: none;">
                <svg viewBox="0 0 24 24" class="btn-icon-svg">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke-linecap="round" stroke-linejoin="round">
                    </path>
                    <polyline points="7 10 12 15 17 10" stroke-linecap="round" stroke-linejoin="round"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3" stroke-linecap="round" stroke-linejoin="round"></line>
                </svg>
                Exportar CSV
            </a>
        </div>

        <form action="/" method="GET" class="filter-form">
            <!-- Ensure hidden inputs for sort/dir if we want to keep them on filter change, 
                 though usually filters reset sort, let's keep it simple -->
            <div class="filter-group">
                <select name="status" onchange="this.form.submit()">
                    <option value="all" {% if current_filters.status=='all' %}selected{% endif %}>Todas los estados
                    </option>
                    <option value="active" {% if current_filters.status=='active' %}selected{% endif %}>Activas</option>
                    <option value="expiring_soon" {% if current_filters.status=='expiring_soon' %}selected{% endif %}>⚠️
                        Por Vencer</option>
                    <option value="pending" {% if current_filters.status=='pending' %}selected{% endif %}>Pendientes
                    </option>
                    <option value="expired" {% if current_filters.status=='expired' %}selected{% endif %}>Expiradas
                    </option>
                    <option value="blocked" {% if current_filters.status=='blocked' %}selected{% endif %}>Bloqueadas
                    </option>
                </select>
            </div>

            <div class="filter-group">
                <select name="type" onchange="this.form.submit()">
                    <option value="all" {% if current_filters.type=='all' %}selected{% endif %}>Todos los tipos</option>
                    <option value="TRIAL" {% if current_filters.type=='TRIAL' %}selected{% endif %}>Trial</option>
                    <option value="MENSUAL" {% if current_filters.type=='MENSUAL' %}selected{% endif %}>Mensual</option>
                    <option value="TRIMESTRAL" {% if current_filters.type=='TRIMESTRAL' %}selected{% endif %}>Trimestral
                    </option>
                    <option value="SEMESTRAL" {% if current_filters.type=='SEMESTRAL' %}selected{% endif %}>Semestral
                    </option>
                    <option value="ANUAL" {% if current_filters.type=='ANUAL' %}selected{% endif %}>Anual</option>
                    <option value="LIFETIME" {% if current_filters.type=='LIFETIME' %}selected{% endif %}>Lifetime
                    </option>
                    <option value="CUSTOM" {% if current_filters.type=='CUSTOM' %}selected{% endif %}>Custom</option>
                </select>
            </div>

            <div class="search-group">
                <input type="text" name="q" placeholder="Buscar por código o cliente..."
                    value="{{ current_filters.q }}">
                <button type="submit" class="btn btn-secondary">Buscar</button>
            </div>
        </form>
    </div>

    <!-- License Table -->
    <div class="table-container">
        {% include '_license_table.html' %}
    </div>

    <!-- Pagination -->
    {% if pagination and pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.page > 1 %}
        <a href="{{ url_for('dashboard', page=pagination.page-1, status=current_filters.status, type=current_filters.type, q=current_filters.q, sort=current_filters.sort, dir=current_filters.dir) }}"
            class="btn">&laquo; Prev</a>
        {% endif %}
        <span>Página {{ pagination.page }} de {{ pagination.pages }}</span>
        {% if pagination.page < pagination.pages %} <a
            href="{{ url_for('dashboard', page=pagination.page+1, status=current_filters.status, type=current_filters.type, q=current_filters.q, sort=current_filters.sort, dir=current_filters.dir) }}"
            class="btn">Next &raquo;</a>
            {% endif %}
    </div>
    {% endif %}

</div>

<!-- Modals -->
{% include '_create_modal.html' %}
{% include '_detail_modal.html' %}
{% include '_confirm_dialog.html' %}

{% endblock %}